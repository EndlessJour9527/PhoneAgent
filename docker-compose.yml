version: "3.9"

services:
  phoneagent:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        FRP_VERSION: 0.52.0
    
    container_name: phoneagent-server
    
    # åŠ è½½ .env é…ç½®
    env_file:
      - .env
    
    environment:
      PYTHONUNBUFFERED: 1
      SERVER_HOST: 0.0.0.0
    
    # ============================================
    # ç«¯å£æ˜ å°„ - æ‰€æœ‰æ¥å£å¯è®¿é—®ï¼ˆä¸ä»…é™ localhostï¼‰
    # ============================================
    ports:
      # API Server + Frontend WebSocket + Scrcpy WebSocket
      - "0.0.0.0:8000:8000"
      # Device WebSocket
      - "0.0.0.0:9999:9999"
      # FRP Server
      - "0.0.0.0:7001:7000"  # å®¿ä¸»æœº7001â†’å®¹å™¨7000 (é¿å…ä¸macOS Control Centerå†²çª)
      # FRP Dashboard
      - "0.0.0.0:7501:7500"
      # FRP Client Ports (devices)
      - "0.0.0.0:6100-6199:6100-6199"
    
    # æ•°æ®å·æŒ‚è½½
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./frp:/app/frp
      - ./.env:/app/.env:ro
      # æŒ‚è½½å®¿ä¸»æœºçš„ADBå¯†é’¥ï¼Œä½¿å®¹å™¨å†…ADBå¯ä»¥å¤ç”¨å·²æˆæƒçš„è®¾å¤‡
      - ~/.android:/root/.android:ro
      # ğŸ†• å¼€å‘æ¨¡å¼ï¼šæŒ‚è½½æºä»£ç ä»¥ä¾¿å®æ—¶ç”Ÿæ•ˆï¼ˆæ— éœ€é‡æ–°æ„å»ºï¼‰
      - ./phone_agent:/app/phone_agent
      - ./server:/app/server
    
    # ============================================
    # ç½‘ç»œé…ç½® - ä½¿ç”¨ bridge æ¨¡å¼
    # ============================================
    networks:
      - phoneagent-network
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  web:
    image: node:20-alpine
    container_name: phoneagent-web
    working_dir: /app
    volumes:
      - ./web:/app
    ports:
      - "0.0.0.0:5173:5173"
    environment:
      VITE_API_HOST: "phoneagent-server"
      VITE_API_PORT: "8000"
      VITE_WS_PORT: "9999"
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    networks:
      - phoneagent-network
    depends_on:
      - phoneagent
    restart: unless-stopped

networks:
  phoneagent-network:
    driver: bridge
