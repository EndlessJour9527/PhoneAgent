# PhoneAgent – AI helper notes

- **Architecture**: FastAPI API server plus a dedicated WebSocket server (scrcpy/video + device control) and FRP tunnel; entrypoint config and lifecycle live in [server/api/app.py](server/api/app.py). Device discovery/health lives in [server/services/device_pool.py](server/services/device_pool.py); task orchestration and step streaming are in [server/services/agent_service.py](server/services/agent_service.py) using `PhoneAgent` from [phone_agent/agent.py](phone_agent/agent.py).
- **Runtime config**: Load env via [server/config.py](server/config.py) and `.env` based on [env.example](env.example). Respect MODEL_PROVIDER/CUSTOM_BASE_URL/CUSTOM_API_KEY/CUSTOM_MODEL_NAME for model routing; MAX_TASK_STEPS/MAX_TOKENS/TEMPERATURE gate LLM behavior; MAX_DEVICES/HEALTH_CHECK_INTERVAL affect device pool load.
- **Data + defaults**: Editable JSON defaults in [data/README.md](data/README.md) (app whitelist, anti-detection, shortcuts, prompt cards). Service writes screenshots to `data/screenshots/` and trims after 7 days via [server/tasks/cleanup.py](server/tasks/cleanup.py); don’t hardcode paths.
- **Backend behaviors**: Web API routes live in [server/api/routes.py](server/api/routes.py) (devices/tasks/ports/speech/shortcuts/prompt-cards/planning/model-stats/scrcpy). Device status blends FRP scan + WS heartbeat; always consult device_pool APIs instead of ad-hoc queries. AgentService emits websocket broadcasts via injected callback—wire new background signals through `set_websocket_broadcast_callback` rather than new global sockets.
- **Agent loop**: `PhoneAgent` builds context with screenshot + `get_current_app` and parses actions via `parse_action` (AST, not eval) in [phone_agent/actions/handler.py](phone_agent/actions/handler.py); actions map to adb/yadb helpers (smart text uses `smart_type_text`). Step callbacks (`on_step_start/on_step_complete`) are synchronous and scheduled back to the event loop—keep them lightweight.
- **Commands**: Dev server stack: `bash scripts/server/start.sh` (starts FRP, WS, uvicorn) / `stop.sh` / `status.sh` / `restart.sh`. Manual dev: activate venv then run `python -m server.websocket.server` and `uvicorn server.api.app:app --host 0.0.0.0 --port 8000`. Frontend: `cd web && npm install && npm run dev -- --host 0.0.0.0` (Vite). Installer script `scripts/install/install_server.sh` also installs ffmpeg.
- **Env & ports**: Default ports: FRP 7000, API 8000 (REST + scrcpy WS + frontend WS), device WS 9999, FRP clients 6100-6199. Frontend CORS/WS hosts configured via env (CORS_ORIGINS, WEBSOCKET_HOST/PORT, VITE_API_HOST/VITE_WS_PORT).
- **Safety/anti-detection**: Anti-detection knobs (time randomization, coordinate jitter, Bezier swipes, whitelist) live in `data/anti_detection_config.json` and are surfaced through API routes—edit there, not in code.
- **Android client**: Remote APK kept at [android-remote-control](android-remote-control/README.md); keep `targetSdk` at 28 (Termux/FRP exec requirement). Assets and screenshots catalog in [assets/README.md](assets/README.md).
- **Logging**: Logging config in [server/logging_config.py](server/logging_config.py); Task-level logs use `TaskLogger` (JSONL) inside AgentService. Cleanup trims `logs/*.log` and JSONL after 30 days—avoid custom log dirs without updating cleanup.
- **Database**: SQLite via SQLAlchemy under `data/client_device.db` (autocreated). When adding models, wire them through [server/database](server/database) CRUD helpers.
- **Testing**: Pytest config in [pyproject.toml](pyproject.toml) with `tests/` root; prefer async-friendly tests (`pytest-asyncio`).
- **Patterns to follow**: Reuse helpers in `server/utils` (e.g., `device_id_to_adb_address`, screenshot compression) and `phone_agent/adb` instead of shelling out. Keep websocket broadcasts JSON-serializable and small; large blobs should be stored (e.g., screenshot files) and referenced by path.
- **Common pitfalls**: Missing `.env` (must set ZHIPU_API_KEY or CUSTOM_API_KEY), forgetting `adb tcpip 5555` on devices (causes offline), bumping targetSdk on Android client, or bypassing `device_pool` state when assigning devices.

Feel free to trim/extend these notes as code evolves; ping to clarify anything fuzzy.